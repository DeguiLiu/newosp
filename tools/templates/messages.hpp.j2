/**
 * @file {{ filename }}
 * @brief Auto-generated by ospgen from {{ input_file }}. DO NOT EDIT.
 *
 * Regenerate: python3 tools/ospgen.py --input defs/{{ input_file }} --output <path>
 */

#ifndef {{ guard }}
#define {{ guard }}

{% for inc in includes | default([]) %}
#include <{{ inc }}>
{% endfor %}
#include <type_traits>
#include <variant>

{% if namespace is defined %}
namespace {{ namespace }} {
{% endif %}

// ============================================================================
// Events
// ============================================================================

{% if events is defined and events | length > 0 %}
{% set ns = namespace | default("") %}
{% set enum_name = (ns | capitalize) + "Event" if ns else "Event" %}
enum {{ enum_name }} : uint32_t {
{% for evt in events %}
  {{ snake_to_k_prefix(ns, evt.name) }} = {{ evt.id }}{{ "," if not loop.last else "" }}
{% endfor %}
};
{% endif %}

// ============================================================================
// Messages
// ============================================================================

{% for msg in messages | default([]) %}
struct {{ msg.name }} {
{% for field in msg.fields %}
{% set arr = parse_array_type(field.type) %}
{% if arr %}
  {{ arr[0] }} {{ field.name }}[{{ arr[1] }}];
{% else %}
  {{ field.type }} {{ field.name }};
{% endif %}
{% endfor %}

  {{ msg.name }}() noexcept
{% for field in msg.fields %}
{% set arr = parse_array_type(field.type) %}
{% if arr %}
      {{ ": " if loop.first else "  " }}{{ field.name }}{}{{ "," if not loop.last else " {}" }}
{% else %}
      {{ ": " if loop.first else "  " }}{{ field.name }}({{ field.default | default("0") }}){{ "," if not loop.last else " {}" }}
{% endif %}
{% endfor %}
};

{% endfor %}

// ============================================================================
// Payload variant
// ============================================================================

{% if messages is defined and messages | length > 0 %}
{% set ns = namespace | default("") %}
{% set payload_name = (ns | capitalize) + "Payload" if ns else "Payload" %}
using {{ payload_name }} = std::variant<
{% for msg in messages %}
    {{ msg.name }}{{ "," if not loop.last else "" }}
{% endfor %}
>;
{% endif %}

// ============================================================================
// Static assertions (trivially copyable)
// ============================================================================

{% for msg in messages | default([]) %}
static_assert(std::is_trivially_copyable<{{ msg.name }}>::value,
              "{{ msg.name }} must be trivially copyable");
{% endfor %}

{% if namespace is defined %}
}  // namespace {{ namespace }}
{% endif %}

#endif  // {{ guard }}
